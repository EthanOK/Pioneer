# ERC-4337 与 EIP-3074：错误的对立
## 什么是账户抽象？

每个以太坊账户都实现了以下五种功能：
+ 验证
+ 授权
+ 重放保护
+ Gas 支付
+ 执行

EOA 以硬编码方式实现它们：

+ **身份验证**和**授权**捆绑在一起：通过不可变的 ECDSA 密钥证明身份并授予其完整的权限。
+ **重放保护**是一个简单的随机数 - 一个单调递增的计数器。
+ **Gas 支付**直接从 EOA 的 ETH 余额中完成。
+ **执行** - 对单个目标的单个调用。

账户抽象意味着以下五个功能的实现：

+ **身份验证** - 任何能够证明身份的方式。
+ **授权** - 任何访问策略。
+ **重放保护** - 事务排序与重放保护分离。
+ **Gas 支付** - Gas 支付与账户本身脱钩。
+ **执行** - 任何执行逻辑。

## 账户抽象示例

+ 不同的签名方案
  + secp256r1（安全飞地、密钥）
  + Schnorr 签名
  + BLS 签名
  + 后量子 (Post-quantum)
  + ZK 证明（例如 zkemail）
+ 密钥更换
  + 更换风险密钥
  + 遗嘱保险柜（如果账户一年未活跃，密钥变为激活状态） 
+ 不同的访问策略
  + 多重签名
  + 基于角色的访问
  + dapp 特定的会话密钥
  + 社交恢复
+ 不同的重放保护方案
  + 来自不同实体的并行交易
  + 由第三方发送的预签名交易
  + 管理通道
+ Gas 抽象
  + 第三方 Gas 支付
  + 使用 ETH 以外的资产进行支付
  + 隐私：匿名空投认领或从 ZK Rollups 或 Mixer 中提现
+ 执行抽象
  + 批量调用多个服务（例如 approve + transferFrom）
  + 原子性
  + dapp 用户体验改进

## ERC-4337 与 EIP-3074：错误的对立

EIP-3074 旨在通过支持任意逻辑的调用合约来增强 EOA 使执行变得抽象。 它具有独特的属性，即无需将资产迁移到新账户即可扩展 EOA 的功能。 它不需要解决去中心化访问等问题，因为交易执行不会影响这一点。 其他四个抽象虽然受影响，但它们不在 EIP-3074 的范围。

ERC-4337 旨在抽象整个账户的所有五种功能。由于需要保留去中心化和抗审查，使这个问题变得更难解决。 ERC-4337 的重点是通过去中心化的基础设施并抽象前四个功能来减轻 DoS 和Griefing 攻击的影响。 作为 ERC，它无法扩展 EOA 的功能，并且需要迁移到智能合约账户。

这两种方法之间的重叠功能很小：只有执行抽象有重叠。

此外，每种方法都旨在解决另一种方法没有解决的问题：EIP-3074 旨在服务现有的 EOA 并让事情尽可能简单。 ERC-4337 旨在不牺牲以太坊核心特性（如去中心化）的基础上，提供完整的账户抽象。

如果坚持将 ERC-4337 与之前的提案进行比较，最接近的是 EIP-2938，而不是 EIP-3074。 EIP-2938 是账户抽象方面的突破，第一个意识到在 AA 内存池中减轻 DoS 攻击的困难。 ERC-4337 解决了 EIP-2938 没有解决的某些问题，本文不对 ERC-4337 和 EIP-2938 进行全面的比较。

## ERC-4337和EIP-3074都能解决什么问题？

两者都解决了执行抽象，因此实现了上述用例的最后一类：

+ 批量调用多个服务
+ 原子性
+ dapp 用户体验改进

## EIP-3074 能做什么，而 ERC-4337 不能？

+ EIP-3074 可以向现有 EOA 添加复杂的执行功能
  + ERC-4337 无法向 EOA 添加功能，因为它是 ERC
+ 当仅需要执行抽象时，EIP-3074 更简单，Gas 利用率更高
  + 当仅需要执行抽象时 ERC-4337 完整的账户抽象增加了复杂度

## ERC-4337 能做什么，而 EIP-3074 不能？

+ 仅一天就可以支持任何 EVM 链。无需达成共识
  + 每个链必须通过共识变更才能接纳 EIP-3074
+ 无需许可
  + EOA 钱包仅允许列入白名单的 EIP-3074 调用者。而 ERC-4337 账户可以由任何人建立和使用
+ 完整的账户抽象支持所有上述功能，而不牺牲去中心化
  + 不同的签名方案
    + EIP-3074 使用 ECDSA。 EIP 确实提到了未来使用其他方案的可能，但只要 EOA 本身尊重 ECDSA 密钥，调用者就无法阻止其使用。
  + 密钥更换
    + 对于 EIP-3074，EOA 的密钥依旧不可撤销
  + 不同的访问策略
    + ECDSA 密钥可以绕过调用者并执行账户中的任何操作。 没有细粒度的访问控制
  + 多种重放保护方案
    + 对于 EIP-3074 该账户仍然是 EOA，使用一维随机数。
  + Gas 支付的抽象
    + 该账户用 ETH 支付自己的 Gas 费用。
    + Gas 支付抽象体系可以构建在 EIP-3074 之上，使用中继代替原账户发送元交易。 然而，保护此类中继免受 DoS 和 griefing 攻击是一项艰巨的挑战。 ERC-4337 的大部分复杂度是出于保证这些中继器（bundler）免于许可限制

## EIP-3074 + EIP-5003 可以做 ERC-4337 所做的事情吗？

EIP-5003 通过让 EOA 支持撤销 ECDSA 密钥并成为智能合约来补充 EIP-3074 协议。 作为合约，它可以抽象账户的其余功能，例如 用不同的签名替换 ECDSA、轮换密钥、应用访问策略等。从这个意义上说，它相当于 EIP-6913 和 EIP-7377 等提案的叠加，并且优于 EIP-7377，因为作为操作码，它可以使用 Gas 抽象系统进行迁移。

一旦 EOA 转换为智能合约，就不能再直接进行交易，需要通过另一个 EOA 进行访问。 这就引出了 ERC-4337 旨在解决的问题。 迁移后用户同时存在两种交易方式：

  1. 维护另一个有资金的 EOA 与该账户进行交易，并对每笔交易签名两次。 这否定了账户抽象的价值并导致糟糕的用户体验。
  2. 使用中继来维护有资金的 EOA，将交易上链并由该账户支付 Gas。 保护这样的中继免受 DoS 和 griefing 攻击十分困难，因此一些项目使用需要授权的中继来解决这个问题。 但这违背了去中心化和抗审查精神。
   
保证迁移后的账户的访问权限去中心化的方法是在账户支付 Gas 费前对账户进行限制。 EIP-2938 和 ERC-4337 都采用了这种方法。 [ERC-4337 内存池](https://notes.ethereum.org/@yoav/unified-erc-4337-mempool)提供了一种去中心化的账户交易方式。

总之，EIP-3074 + EIP-5003 只是凸显了 ERC-4337 的作用

### 警告：EOA 迁移的危害

对于现有 EOA 用户来说，直接迁移到智能账户而不是转移资产是很有吸引力的。然而，它也存在一定的漏洞，其中一些漏洞是无法消除的。

如果 EOA 密钥在撤销后被泄露，会出现什么问题？

  1. 该密钥在其他链上仍然有效（包括在迁移时还不存在的链）。它可用于在其他链上认领同一账户，并转移走这些链上该账户的任何资产。
  2. 链下系统（例如 dapp 前端的登录过程）会检查签名。 其中许多支持 EIP-1271 进行智能合约签名，但仅在 ecrecover 失败时才尝试。该密钥可对这些系统上的账户造成危害。
  3. 失效的密钥可以在链上（在被撤销的同一条链上）签署授权许可。 如果账户有支持授权许可的ERC-20代币，这些代币可被失效的密钥窃取。
  4. 跨链桥通常会在提现时检查签名。 如果该账户通过这样的桥将资金发送到另一条链，则可以使用已撤销的密钥在另一侧提取资金。
   
用户可以在迁移后销毁私钥并希望没留下任何副本，但这样做用户就无法在其他链上使用相同的地址。

因此，如果一定要保留旧地址时，迁移应作为最后的手段。 默认情况下，新账户最好使用 CREATE2 进行部署，而不是从 EOA 迁移，这样它们就不会链接到其他链上的 EOA 私钥。

社区往往过分强调 EOA 迁移的重要性，因为当前大多数用户都有 EOA。 接下来的 10 亿用户可以从智能账户开始，而不必从 EOA 迁移。 当前的 EOA 用户，只是其中的一小部分。 对于当前用户来说，迁移可能在一段时间内很重要。 当账户抽象成为常态时，它就很少使用。

## ERC-4337 和 EIP-3074 之间有协同作用吗？

是的，它们可以[组合起来](https://notes.ethereum.org/@yoav/eip-3074-erc-4337-synergy)使用。 如果一条链采用 EIP-3074，那么使用 ERC-4337 的项目就可以利用它来获益。

## RIP-7560：账户抽象的另一条道路

EIP-3074 和 ERC-4337 都是对本地账户抽象化利益的追求。 前者专注于获得执行抽象的所有好处，后者专注于在所有 EVM 链上获得账户抽象的好处，但以非本地方式实现，效率较低。

如果用户希望使用完全的本地账户抽象，可以采用 RIP-7560。 它使用与 ERC-4337 相同的账户和内存池架构，但协议级别在本地。

RIP-7560 不必从第一天起就采用，现有账户可以随时迁移为 RIP-7560：

+ ERC-4337 账户可以迁移为 RIP-7560，而无需更改其架构，只需更增加对 RIP-7560 中 EntryPoint 地址的信任， 一个账户可以轻松兼容 ERC-4337 和 RIP-7560，甚至不需要迁移。
+ EOA 或许能够直接迁移到 RIP-7560，而无需经过 ERC-4337 或 EIP-3074。 RIP-7560 已经支持 EOA 的 Gas 抽象。未来的 RIP 可以让 EOA 设置其代码，无论是使用 SETCODE (EIP-6913) 或 AUTHUSURP (EIP-5003) 等操作码，还是通过添加类似于 EIP-7377 的 TransactionType4 子类型。 此操作码/子类型可由在 Type-4 (RIP-7560) 交易中调用的迁移合约使用。 但是，[不鼓励 EOA 迁移](#警告eoa-迁移的危害)。

### RIP-7560 需要您的反馈

在 RIP-7560 正式收录之前，我们正在收集有关 RIP-7560 的反馈。 如果您对本地账户抽象感兴趣，请查看 [PR](https://github.com/ethereum/RIPs/pull/3) 或加入[讨论](https://ethereum-magicians.org/t/rip-7560-native-account-abstraction/16664)。